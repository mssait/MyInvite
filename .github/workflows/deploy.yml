name: CI/CD Pipeline

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Java 8
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '8'

      - name: Install OpenVPN and Network Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y openvpn curl iputils-ping dnsutils
          openvpn --version
          # Create TUN/TAP interface (may fail safely if exists)
          sudo mkdir -p /dev/net
          [ -c /dev/net/tun ] || sudo mknod /dev/net/tun c 10 200
          sudo chmod 666 /dev/net/tun

      - id: vpn-config
        name: Validate and Load OpenVPN Config
        env:
          OPENVPN_CONFIG: ${{ secrets.OPENVPN_CONFIG }}
        run: |
          if [ -z "$OPENVPN_CONFIG" ]; then
            echo "::error::OPENVPN_CONFIG secret is missing"
            exit 1
          fi
          if echo "$OPENVPN_CONFIG" | base64 -d > config.ovpn.tmp 2>/dev/null && [ -s config.ovpn.tmp ]; then
            mv config.ovpn.tmp config.ovpn
          else
            echo "$OPENVPN_CONFIG" > config.ovpn
          fi
          chmod 600 config.ovpn
          echo "config_path=./config.ovpn" >> $GITHUB_OUTPUT

      - name: Connect to VPN
        uses: kota65535/github-openvpn-connect-action@v2
        with:
          config_file: ${{ steps.vpn-config.outputs.config_path }}

      - name: Verify Connection
        run: |
          ip a show tun0 || ip a show tap0 || true
          ip route show
          cat /etc/resolv.conf
          ping -c 4 ${{ secrets.INTERNAL_TEST_IP || '192.168.1.100' }} || echo "Ping failed."

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan 68.233.114.39 >> ~/.ssh/known_hosts

      - name: Build with Maven
        run: |
          mvn -version
          mvn clean package
          ls target/*.war

      - name: Deploy WAR via VPN (Tomcat Manager)
        env:
          TOMCAT_HOST: ${{ secrets.TOMCAT_HOST }}
          TOMCAT_USER: ${{ secrets.TOMCAT_USER }}
          TOMCAT_PASSWORD: ${{ secrets.TOMCAT_PASSWORD }}
        run: |
          WAR=$(ls target/*.war | head -n1)
          echo "Deploying $WAR to Tomcat at $TOMCAT_HOST"
          curl -v -su "${TOMCAT_USER}:${TOMCAT_PASSWORD}" \
            -T "$WAR" \
            "http://${TOMCAT_HOST}/manager/text/deploy?path=/myinvite&update=true"
